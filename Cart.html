<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="Cart.css" />
    <title>Handlekurv</title>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">
        <a href="Index.html">
          <img src="Images/Logo.svg" alt="Vitalis Fitness Logo" />
        </a>
        <span>Vitalis Fitness</span>
      </div>
      <ul class="nav-links">
        <li><a href="Shop.html">Bli medlem</a></li>
        <li><a href="About.html">Om oss</a></li>
        <li>
          <a href="Cart.html"
            ><i class="fa fa-shopping-cart" style="font-size: 24px"></i
          ></a>
        </li>
        <ul class="nav-links">
          <li><a href="#login">Logg Inn</a></li>
          <li><a href="#register" class="cta">Opprett Bruker</a></li>
        </ul>
      </ul>
    </nav>

    <!-- Shopping Cart Section -->
    <section class="cart-section">
      <h1>Din Handlekurv</h1>

      <div class="cart-item-container" id="cart-items">
        <!-- Cart items will be dynamically generated here -->
      </div>

      <div class="cart-summary">
        <h3>Total: <span id="cart-total">0 kr</span></h3>
        <button id="checkout-btn" class="checkout-btn">GÃ¥ til kassen</button>
      </div>
    </section>

    <script>
      // Fetch cart data from MongoDB on page load
      function fetchCartFromMongoDB() {
        fetch("http://localhost:5000/cart")
          .then((response) => response.json())
          .then((cartItems) => {
            displayCartItems(cartItems); // Use the same displayCartItems function
          })
          .catch((error) => {
            console.error("Error fetching cart items from MongoDB:", error);
          });
      }

      // Function to display cart items
      function displayCartItems(cart) {
        const cartItemsContainer = document.getElementById("cart-items");
        const cartTotalContainer = document.getElementById("cart-total");
        cartItemsContainer.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
          const itemRow = document.createElement("div");
          itemRow.classList.add("cart-item");
          itemRow.innerHTML = `
            <div class="product-info">
              <h2>${item.name}</h2>
            </div>
            <div class="price">
              <span>${item.price} kr</span>
            </div>
            <div class="quantity">
              <button class="quantity-btn" onclick="updateQuantity(${index}, 'decrease')">-</button>
              <span>${item.quantity}</span>
              <button class="quantity-btn" onclick="updateQuantity(${index}, 'increase')">+</button>
            </div>
            <button class="remove-btn" onclick="removeFromCart(${index})">&#x2716;</button>
          `;
          cartItemsContainer.appendChild(itemRow);
          total += parseFloat(item.price) * item.quantity;
        });

        cartTotalContainer.textContent = `${total.toFixed(2)} kr`;
      }

      // Update MongoDB when quantity changes
      function updateQuantity(index, action) {
        const cartItem = cart[index];
        if (action === "increase") {
          cartItem.quantity += 1;
        } else if (action === "decrease" && cartItem.quantity > 1) {
          cartItem.quantity -= 1;
        }
        fetch(`http://localhost:5000/cart/${cartItem.id}`, {
          method: "PUT", // Assuming MongoDB update with PUT request
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(cartItem),
        })
          .then(() => fetchCartFromMongoDB()) // Refresh after update
          .catch((error) => {
            console.error("Error updating item quantity:", error);
          });
      }

      // Remove item from cart in MongoDB
      function removeFromCart(index) {
        const cartItem = cart[index];
        fetch(`http://localhost:5000/cart/${cartItem.id}`, {
          method: "DELETE", // Assuming MongoDB remove with DELETE request
        })
          .then(() => fetchCartFromMongoDB()) // Refresh after deletion
          .catch((error) => {
            console.error("Error removing item:", error);
          });
      }

      // Checkout logic (clears cart in MongoDB)
      document.getElementById("checkout-btn").addEventListener("click", () => {
        if (cart.length === 0) {
          alert("Handlekurven er tom.");
        } else {
          fetch("http://localhost:5000/cart/checkout", { method: "POST" }) // Assuming checkout endpoint
            .then(() => {
              alert("Til kassen (utvid med betalingsintegrasjon).");
              fetchCartFromMongoDB(); // Clear cart after checkout
            })
            .catch((error) => {
              console.error("Error during checkout:", error);
            });
        }
      });

      // Fetch and display cart items on page load
      fetchCartFromMongoDB();
    </script>
  </body>
</html>
